From df886c72da903dba05a5b7d87d9d09997d345a77 Mon Sep 17 00:00:00 2001
From: Tomasz Wozniak <t.wozniak@samsung.com>
Date: Fri, 29 Sep 2017 14:13:37 +0200
Subject: [PATCH] Stub of setjmp/longjmp for stm32

---
 arch/arm/src/common/setjmp.c | 37 +++++++++++++++++++++++++++++++++++++
 arch/arm/src/stm32/Make.defs |  2 +-
 include/setjmp.h             | 35 +++++++++++++++++++++++++++++++++++
 3 files changed, 73 insertions(+), 1 deletion(-)
 create mode 100644 arch/arm/src/common/setjmp.c
 create mode 100644 include/setjmp.h

diff --git a/arch/arm/src/common/setjmp.c b/arch/arm/src/common/setjmp.c
new file mode 100644
index 0000000..57729f5
--- /dev/null
+++ b/arch/arm/src/common/setjmp.c
@@ -0,0 +1,37 @@
+/****************************************************************************
+ *
+ * Copyright 2017 Samsung Electronics All Rights Reserved.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
+ * either express or implied. See the License for the specific
+ * language governing permissions and limitations under the License.
+ *
+ ****************************************************************************/
+
+#include <setjmp.h>
+
+#include <stdio.h>
+
+void longjmp(jmp_buf env, int savesigs) {
+  (void)env;
+  (void)savesigs;
+  void *caller;
+  __asm__("mov %0, lr\n" : "=r"(caller) : : );
+  fprintf(stderr, "longjmp called at %p, aborting\n", caller);
+  *(int *)0x61707544 = 193;
+  *(int *)0 = 0x61707544;
+  __builtin_unreachable();
+}
+
+int setjmp(jmp_buf env) {
+  (void)env;
+  return 0;
+}
diff --git a/arch/arm/src/stm32/Make.defs b/arch/arm/src/stm32/Make.defs
index 8b10228..d2c2607 100644
--- a/arch/arm/src/stm32/Make.defs
+++ b/arch/arm/src/stm32/Make.defs
@@ -52,7 +52,7 @@ CMN_CSRCS += up_memfault.c up_modifyreg8.c up_modifyreg16.c up_modifyreg32.c
 CMN_CSRCS += up_releasepending.c up_releasestack.c up_reprioritizertr.c
 CMN_CSRCS += up_schedulesigaction.c up_sigdeliver.c up_stackframe.c
 CMN_CSRCS += up_systemreset.c up_unblocktask.c up_usestack.c up_doirq.c
-CMN_CSRCS += up_hardfault.c up_svcall.c up_vfork.c
+CMN_CSRCS += up_hardfault.c up_svcall.c up_vfork.c setjmp.c
 
 ifeq ($(CONFIG_ARMV7M_STACKCHECK),y)
 CMN_CSRCS += up_stackcheck.c
diff --git a/include/setjmp.h b/include/setjmp.h
new file mode 100644
index 0000000..bf5772e
--- /dev/null
+++ b/include/setjmp.h
@@ -0,0 +1,35 @@
+/****************************************************************************
+ *
+ * Copyright 2017 Samsung Electronics All Rights Reserved.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
+ * either express or implied. See the License for the specific
+ * language governing permissions and limitations under the License.
+ *
+ ****************************************************************************/
+
+#ifndef __INCLUDE_SETJMP_H
+#define __INCLUDE_SETJMP_H
+
+#ifdef __cplusplus
+extern "C" {
+#endif
+
+typedef struct _jmp_buf { int _jb[1]; } jmp_buf[1];
+
+void longjmp(jmp_buf env, int savesigs) __attribute__((noreturn));
+int setjmp(jmp_buf env);
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif							/* __INCLUDE_SETJMP_H */
-- 
2.7.4

